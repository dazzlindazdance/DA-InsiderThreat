<form>
  <label>User Metrics</label>
  <search id="base_search1">
    <query>index=it_risk |  `get_identity4insiderevents(risk_object)`|search risk_object_identity="$risk_object$"|eval search_name=case(source="Manual Risk Score Modification",source,source="Risk Score Degradation","Risk Score Reduction",1=1,search_name)|stats count by search_name,risk_score,_time</query>
    <earliest>-7d</earliest>
    <latest>now</latest>
    <sampleRatio>1</sampleRatio>
  </search>
  <fieldset submitButton="false" autoRun="true">
    <input type="text" token="search_risk_object" searchWhenChanged="true">
      <label>Free identity text filter:</label>
      <default>*</default>
      <prefix>*</prefix>
      <suffix>*</suffix>
      <initialValue>*</initialValue>
    </input>  
    <input type="dropdown" token="risk_object" searchWhenChanged="true">
      <label>Identity</label>
      <fieldForLabel>risk_object</fieldForLabel>
      <fieldForValue>risk_object</fieldForValue>
      <search>
        <query>index=it_risk risk_object="$search_risk_object$" | stats count by risk_object | sort limit=10000 risk_object | fields risk_object</query>
        <earliest>0</earliest>
        <latest></latest>
      </search>
      <change>
        <unset token="display_detail"></unset>
      </change>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Current User Risk Score</title>
      <viz type="horseshoe_meter_app.horseshoe_meter">
        <search base="base_search1">
          <query>| stats sum(risk_score) AS "Current Score"| eval "Current Score"=if('Current Score'&lt;0,0,'Current Score')</query>
        </search>
        <option name="drilldown">none</option>
        <option name="horseshoe_meter_app.horseshoe_meter.backgroundColor">#FFF</option>
        <option name="horseshoe_meter_app.horseshoe_meter.dialColor">#d0d5d9</option>
        <option name="horseshoe_meter_app.horseshoe_meter.maxRangeColor">#b44441</option>
        <option name="horseshoe_meter_app.horseshoe_meter.maxRangeThreshold">100</option>
        <option name="horseshoe_meter_app.horseshoe_meter.maxValue">100</option>
        <option name="horseshoe_meter_app.horseshoe_meter.midRangeColor">#fbcd2f</option>
        <option name="horseshoe_meter_app.horseshoe_meter.midRangeThreshold">10</option>
        <option name="horseshoe_meter_app.horseshoe_meter.minRangeColor">#3fc77a</option>
        <option name="horseshoe_meter_app.horseshoe_meter.minValue">0</option>
        <option name="horseshoe_meter_app.horseshoe_meter.thresholdStyle">realValue</option>
        <option name="horseshoe_meter_app.horseshoe_meter.useRangemap">true</option>
        <option name="horseshoe_meter_app.horseshoe_meter.valueColor">#555</option>
        <option name="refresh.display">progressbar</option>
      </viz>
    </panel>
    <panel>
      <title>Identity Information Held</title>
      <table>
        <search>
          <query>|`identities`| search identity=$risk_object$ | table identity,first,last,nick,email,phone,priority,watchlist,startDate,endDate,bunit,managedBy</query>
        </search>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Timeline of Risk Events</title>
      <viz type="timeline_app.timeline">
        <search base="base_search1">
          <query>|eval duration=60,severity="high"| table _time,search_name,severity,duration | appendpipe [|stats count | where count=0 | addinfo | rename info_min_time AS _time |table _time,search_name,severity,duration]</query>
        </search>
        <option name="refresh.display">progressbar</option>
        <option name="timeline_app.timeline.axisTimeFormat">DAYS</option>
        <option name="timeline_app.timeline.colorMode">categorical</option>
        <option name="timeline_app.timeline.maxColor">#DA5C5C</option>
        <option name="timeline_app.timeline.minColor">#FFE8E8</option>
        <option name="timeline_app.timeline.numOfBins">6</option>
        <option name="timeline_app.timeline.tooltipTimeFormat">MINUTES</option>
        <option name="timeline_app.timeline.useColors">1</option>
        <drilldown>
          <set token="display_detail">true</set>
        </drilldown>
      </viz>
      <html>
        <center>Click the chart content to expose detail.</center>
      </html>
      <table id="detail" depends="$display_detail$">
        <search>
          <earliest>-7d@h</earliest>
          <latest>now</latest>
          <query>index=it_risk |  `get_identity4insiderevents(risk_object)`|search risk_object_identity="$risk_object$"|eval search_name=case(source="Manual Risk Score Modification",source,source="Risk Score Degradation","Risk Score Reduction",1=1,search_name) | fields - count,annotations,info_max_time,info_min_time,risk_object_*,savedsearch_description,orig_sid,orig_rid,orig_action_name,linecount,host,source,sourcetype,splunk_server,splunk_server_group,src_user_*,timestamp,index| stats values(risk_score) AS risk_score,values(*) AS * by orig_time,risk_object,search_name | rename orig_time AS _time</query>
        </search>
        <format type="color" field="risk_score">
          <colorPalette type="minMidMax" maxColor="#DC4E41" minColor="#FFFFFF"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Risk Scoring over Last 7 Days</title>
      <chart>
        <search base="base_search1">
          <query>| replace * with tmp_* IN search_name |timechart span=1d sum(risk_score) by search_name|addtotals label=score tmp_* |rename tmp_* AS * |eventstats sum(Total) AS Total</query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.overlayFields">Total</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
    <panel>
      <title>Notables Generated in the Last year</title>
      <chart>
        <search>
          <query>`notable`| search security_domain="insider" risk_object="$risk_object$"| timechart span=1w count by status_label | appendpipe [| stats count | where count=0| eval status_label="none"]</query>
          <earliest>-365d@d</earliest>
          <latest>now</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">/app/DA-InsiderThreat/incident_review?source=Identity%20-%20Insider%20Threat%20Risk%20Threshold%20Breached%20-%20Rule&amp;search=user%253D$risk_object$&amp;earliest=-365d&amp;latest=now</link>
        </drilldown>
      </chart>
    </panel>
  </row>
</form>